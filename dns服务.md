# 一、概念介绍  
## DNS服务
DNS:Domain Name Service 应用层协议  
C/S,  
使用端口：53/udp, 53/tcp  
UDP53端口供查询用，必须开放  
TCP53端口供主从同步用    
BIND：Bekerley Internat Name Domain  
ISC （www.isc.org）  
本地名称解析配置文件：  hosts  
/etc/hosts  
%WINDIR%/system32/drivers/etc/hosts  
122.10.117.2    www.magedu.com  
93.46.8.89 www.google.com  
## DNS域名
根域  
一级域名：Top Level Domain: tld
com, edu, mil, gov, net, org, int,arpa  
三类：组织域、国家域(.cn, .ca, .hk, .tw)、 反向域  
二级域名  
三级域名  
最多127级域名  
ICANN（The Internet Corporation for Assigned Names and Numbers）
互联网名称与数字地址分配机构，负责在全球范围内对互联网通用顶级域名
（gTLD）以及国家和地区顶级域名（ccTLD）系统的管理、以及根服务器系统
的管理
  
![a](https://github.com/kongweichen/Linux-/blob/master/picture/DNS.PNG?raw=true)  
# 二、软件介绍及实验讲解 
常用工具：软件包bind  
```bash
 [root@Centos7 /misc/cd 16:56:27]#yum info bind
Loaded plugins: fastestmirror, langpacks
Loading mirror speeds from cached hostfile
Installed Packages
Name        : bind
Arch        : x86_64
Epoch       : 32
Version     : 9.9.4
Release     : 61.el7
Size        : 4.3 M
Repo        : installed
From repo   : development
Summary     : The Berkeley Internet Name Domain (BIND) DNS (Domain Name System) server
URL         : http://www.isc.org/products/BIND/
License     : ISC
Description : BIND (Berkeley Internet Name Domain) is an implementation of the DNS
            : (Domain Name System) protocols. BIND includes a DNS server (named),
            : which resolves host names to IP addresses; a resolver library
            : (routines for applications to use when interfacing with DNS); and
            : tools for verifying that the DNS server is operating properly.
            ```
相关用到的文件夹：  
/etc/named.conf  
/var/log/named.log

/etc/named.conf中部分重要的语句块  
（1）基本设置，如监听地址等
```bash

options {
        listen-on port 53 { 127.0.0.1; };                                    
        listen-on-v6 port 53 { ::1; };
        directory       "/var/named";
        dump-file       "/var/named/data/cache_dump.db";
        statistics-file "/var/named/data/named_stats.txt";
        memstatistics-file "/var/named/data/named_mem_stats.txt";
        allow-query     { localhost; };

        /* 
```

（2）关于日志、域等  
```bash
logging {
        channel default_debug {
                file "data/named.run";
                severity dynamic;
        };
};

zone "." IN {
        type hint;   
        file "named.ca"; 
};

include "/etc/named.rfc1912.zones";
include "/etc/named.root.key";
```

/usr/sbin/rndc  该工具可控制DNS服务  
如果对配置文件修改后，可以使用命令 rndc reload 进行更新  

## 实验1 搭建只缓存服务器
### 1主机centos7作为dns服务器，下载软件包bind  
### 2对主机centos6进行相关修改，使其作为客户端  
首先在/etc/sysconfig/network-scripts/ifcfg-eth0 中修改DNS1  
```bash

[root@centos6 network-scripts]# cat ifcfg-eth0 
DEVICE=eth0
TYPE=Ethernet
UUID=d43cfb04-68d3-4b8f-a980-52642c4fb7e0
ONBOOT=yes
NM_CONTROLLED=yes
BOOTPROTO=static
IPADDR=192.168.244.152
NETMASK=255.255.255.0
DNS1=192.168.244.144    ——指定DNS地址，地址是服务器的ip
HWADDR=00:0C:29:AD:35:35
DEFROUTE=yes
PEERDNS=yes
PEERROUTES=yes
IPV4_FAILURE_FATAL=yes
IPV6INIT=no
NAME="System eth0"
```
然后可查看/etc/resolv.conf 查看是否只有指定的DNS地址，如果没有，可以使用#暂时注销
```bash
[root@centos6 network-scripts]# cat /etc/resolv.conf 
# Generated by NetworkManager
#domain magedu.com       ————暂时注销
#search magedu.com localdomain      ————暂时注销
search localdomain
#nameserver 223.5.5.5    ————暂时注销
#nameserver 223.6.6.6    ————暂时注销
nameserver 192.168.244.144
[root@centos6 network-scripts]# 
```
### 3.对服务器端DNS服务的配置文件/etc/named.conf进行修改，内容和方法如下 
对配置文件中 options 语句块进行修改  
（1）listen-on port 这一行：监听端口修改：改为 localhost 或 整行注释掉  
（2）allow-query 这一行：权限改为 any，或整行注释掉  
（3）使用命令 named-checkconf 检查语法  
（4）命令 rndc reload  或 systemctl restart named 进行更新加载  

```bash

options {
        listen-on port 53 { localhost; };
        listen-on-v6 port 53 { ::1; };
        directory       "/var/named";
        dump-file       "/var/named/data/cache_dump.db";
        statistics-file "/var/named/data/named_stats.txt";
        memstatistics-file "/var/named/data/named_mem_stats.txt";
        allow-query     { any; };
[root@Centos7 ~ 19:54:04]#named-checkconf
[root@Centos7 ~ 19:54:14]#rndc reload         
server reload successful
```
### 4.只缓存服务器搭建完毕，服务器只具有转发、缓存功能，客户端可以通过DNS实现解析，解析效果如下
```bash
[root@centos6 network-scripts]# dig www.baidu.com

; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.68.rc1.el6 <<>> www.baidu.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 1057
;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 5, ADDITIONAL: 5

;; QUESTION SECTION:
;www.baidu.com.                 IN      A

;; ANSWER SECTION:
www.baidu.com.          1200    IN      CNAME   www.a.shifen.com.
www.a.shifen.com.       300     IN      A       61.135.169.125
www.a.shifen.com.       300     IN      A       61.135.169.121

;; AUTHORITY SECTION:
a.shifen.com.           1199    IN      NS      ns2.a.shifen.com.
a.shifen.com.           1199    IN      NS      ns4.a.shifen.com.
a.shifen.com.           1199    IN      NS      ns5.a.shifen.com.
a.shifen.com.           1199    IN      NS      ns1.a.shifen.com.
a.shifen.com.           1199    IN      NS      ns3.a.shifen.com.

;; ADDITIONAL SECTION:
ns4.a.shifen.com.       1199    IN      A       14.215.177.229
ns2.a.shifen.com.       1199    IN      A       220.181.57.142
ns1.a.shifen.com.       1199    IN      A       61.135.165.224
ns5.a.shifen.com.       1199    IN      A       180.76.76.95
ns3.a.shifen.com.       1199    IN      A       112.80.255.253

;; Query time: 4618 msec
;; SERVER: 192.168.244.144#53(192.168.244.144)
;; WHEN: Sat Nov 24 20:18:09 2018
;; MSG SIZE  rcvd: 260
```

## 实验二：搭建权威DNS服务器，可以真正进行解析  
查询、测试谁是权威的DNS服务器  
dig -t ns 域名  
```bash

[root@centos6 network-scripts]# dig -t ns magedu.com   

; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.68.rc1.el6 <<>> -t ns magedu.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 27248
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 0    “————这一行里如果qr 后面出现 aa ，则DNS服务器是权威DNS服务器，反之是只缓存服务器”  

;; QUESTION SECTION:
;magedu.com.                    IN      NS

;; ANSWER SECTION:
magedu.com.             86400   IN      NS      dns9.hichina.com.
magedu.com.             86400   IN      NS      dns10.hichina.com.

;; Query time: 530 msec
;; SERVER: 192.168.244.144#53(192.168.244.144)
;; WHEN: Sat Nov 24 20:30:46 2018
;; MSG SIZE  rcvd: 75
```
类似的测试命令还有host/nslookup等  
host命令：
```bash  
[root@centos6 network-scripts]# host www.magedu.com
www.magedu.com has address 101.200.188.230

[root@centos6 network-scripts]# host www.magedu.com @140.205.81.25
host: couldn't get address for '@140.205.81.25': not found
[root@centos6 network-scripts]# host www.magedu.com 140.205.81.25 
Using domain server:
Name: 140.205.81.25
Address: 140.205.81.25#53
Aliases: 
```
nslookup命令：  
```bash
[root@centos6 network-scripts]# nslookup
> server 140.205.81.25  ————这里是要测试的DNS服务器IP
Default server: 140.205.81.25
Address: 140.205.81.25#53
> www.magedu.com
Server:         140.205.81.25
Address:        140.205.81.25#53

Name:   www.magedu.com
Address: 101.200.188.230
```
### 1.按照实验一搭建只缓存DNS服务器  
### 2.对DNS服务器进行修改
查看配置文件中有关“域”zone的语句块
```bash
zone "." IN {
        type hint;
        file "named.ca";
};

include "/etc/named.rfc1912.zones";
include "/etc/named.root.key";
```

    
进入文件/etc/named.rfc1912.zones 中，按照格式范例修改  
```bash
[root@Centos7 ~ 09:47:19]#vim /etc/named.rfc1912.zones 
// named.rfc1912.zones:                                                                                        
//
// Provided by Red Hat caching-nameserver package 
//
// ISC BIND named zone configuration for zones recommended by
// RFC 1912 section 4.1 : localhost TLDs and address zones
// and http://www.ietf.org/internet-drafts/draft-ietf-dnsop-default-local-zones-02.txt
// (c)2007 R W Franks
// 
// See /usr/share/doc/bind*/sample/ for example named configuration files.
//

zone "magedu.com" IN {
        type master;
        file "magedu.com.zone";  
        allow-update { none; };
};    ————按照此格式修改，建立一个域  
```  
### 3.在/var/named 下建立相关区域数据库文件，并进行相应的修改
```bash
[root@Centos7 ~ 09:59:05]#ll /var/named/
total 20
drwxrwx---. 2 named named   23 Nov 24 10:52 data
drwxrwx---. 2 named named   31 Nov 25 18:38 dynamic
-rw-r-----  1 root  named  222 Nov 25 21:41 magedu.com.zone    ————建立该文件，可通过复制 named.localhost并改名的方式建立
-rw-r-----. 1 root  named 2281 May 22  2017 named.ca
-rw-r-----. 1 root  named  152 Dec 15  2009 named.empty
-rw-r-----. 1 root  named  152 Jun 21  2007 named.localhost
-rw-r-----. 1 root  named  168 Dec 15  2009 named.loopback
drwxrwx---. 2 named named    6 Apr 13  2018 slaves
```

修改完善后文件/var/named/magedu.com.zone的格式内容如下：
```bash
[root@Centos7 ~ 11:08:58]#vim /var/named/magedu.com.zone                        
$TTL 1D
@       IN SOA  DNS1 admin.magedu.com. (
                                        0       ; serial
                                        1D      ; refresh
                                        1H      ; retry
                                        1W      ; expire
                                        3H )    ; minimum
        NS      DNS1
DNS1    A       192.168.244.144
www     CNAME   webserv
webserv  A      9.9.9.9
webserv  A      8.8.8.8
webserv  A      114.114.114.114
webserv  A      12.34.11.11
log      A       7.7.7.7
yunwei.magedu.com. A 6.6.6.6
@      MX     10  mailserv1
@      MX     20  mailserv2                                                                                                                              
mailserv1  A    11.11.11.11
mailserv2  A    12.12.12.12

"/var/named/magedu.com.zone" 22L, 450C written                                                                                         
[root@Centos7 ~ 11:09:47]#named-checkzone magedu.com /var/named/magedu.com.zone 
zone magedu.com/IN: loaded serial 0
OK
[root@Centos7 ~ 11:09:49]#rndc reload
server reload successful
```
至此，权威正向解析DNS服务器搭建完成。


## 对区域数据库文件的修改、解读  
**资源记录**  
区域解析库：由众多RR组成：  
资源记录：Resource Record, RR  
记录类型：A, AAAA, PTR, SOA, NS, CNAME, MX  
SOA：Start Of Authority，起始授权记录；一个区域解析库有且仅能有一个  
SOA记录，必须位于解析库的第一条记录  
A：internet Address，作用，FQDN --> IP  
AAAA：FQDN --> IPv6  
PTR：PoinTeR，IP --> FQDN  
NS：Name Server，专用于标明当前区域的DNS服务器  
CNAME ： Canonical Name，别名记录  
MX：Mail eXchanger，邮件交换器  
TXT：对域名进行标识和说明的一种方式，一般做验证记录时会使用此项，如：  
SPF（反垃圾邮件）记录，https验证等  

**资源记录定义的格式：**  
语法：name [TTL] IN rr_type value  
***注意***：  
(1) TTL可从全局继承  
(2) @可用于引用当前区域的名字  
(3) 同一个名字可以通过多条记录定义多个不同的值；此时DNS服务器会以轮询
方式响应  
(4) 同一个值也可能有多个不同的定义名字；通过多个不同的名字指向同一个值
进行定义；此仅表示通过多个不同的名字可以找到同一个主机  
**SOA记录**  
 name: 当前区域的名字，例如“magedu.com.”  
 value: 有多部分组成  
 (1) 当前区域的主DNS服务器的FQDN，也可以使用当前区域的名字；  
 (2) 当前区域管理员的邮箱地址；但地址中不能使用@符号，一般用.替换
例如：admin.magedu.com  
 (3) 主从服务区域传输相关定义以及否定的答案的统一的TTL  
 例如：  
```bash
magedu.com.       IN SOA  DNS1 admin.magedu.com. (
                                        0       ; serial
                                        1D      ; refresh
                                        1H      ; retry
                                        1W      ; expire
                                        3H )    ; minimum
```
**NS记录**  
name: 当前区域的名字  
value: 当前区域的某DNS服务器的名字，例如ns.magedu.com.  
***注意***：一个区域可以有多个NS记录  
例如：  
magedu.com. IN NS ns1.magedu.com.  
magedu.com. IN NS ns2.magedu.com.  
***注意***：  
(1) 相邻的两个资源记录的name相同时，后续的可省略  
(2) 对NS记录而言，任何一个ns记录后面的服务器名字，都应该在后续有
一个A记录  
**MX记录**
name: 当前区域的名字  
value: 当前区域的某邮件服务器(smtp服务器)的主机名  
一个区域内，MX记录可有多个；但每个记录的value之前应该有一个数字(0-
99)，表示此服务器的优先级；数字越小优先级越高  
例如：  
magedu.com. IN MX 10 mx1.magedu.com.  
IN MX 20 mx2.magedu.com.  
***注意***：对MX记录而言，任何一个MX记录后面的服务器名字，都应该在后续有
一个A记录  
**A记录**  
name: 某主机的FQDN，例如www.magedu.com.  
value: 主机名对应主机的IP地址  
例如：  
```bash  
www.magedu.com. IN A 1.1.1.1
www.magedu.com. IN A 2.2.2.2
mx1.magedu.com. IN A3.3.3.3
mx2.magedu.com. IN A 4.4.4.4
$GENERATE 1-254 HOST$ A 1.2.3.$
*.magedu.com. IN A 5.5.5.5
magedu.com. IN A 6.6.6.6
```
避免用户写错名称时给错误答案，可通过泛域名解析进行解析至某特定地址其它记录  
AAAA:  
name: FQDN  
value: IPv6  
**PTR**:  
name: IP，有特定格式，把IP地址反过来写，1.2.3.4，要写作4.3.2.1；而
有特定后缀：in-addr.arpa.，所以完整写法为：  4.3.2.1.in-addr.arpa.
value: FQDN  
例如：  
4.3.2.1.in-addr.arpa. IN PTR www.magedu.com.  
如1.2.3为网络地址，可简写成：
4 IN PTR www.magedu.com.  
***注意***：网络地址及后缀可省略；主机地址依然需要反着写别名记录  
**CNAME**：  
name: 别名的FQDN  
value: 真正名字的FQDN  
例如：
www.magedu.com. IN CNAME websrv.maged  

图例：下面是数据库文件/var/named/magedu.com.zone ,有各种类型的记录及格式
```bash
[root@Centos7 /var/named 12:32:47]#vim magedu.com.zone 
$TTL 1D
@       IN SOA  DNS1 admin.magedu.com. (
                                        0       ; serial
                                        1D      ; refresh
                                        1H      ; retry
                                        1W      ; expire
                                        3H )    ; minimum
        NS      DNS1
DNS1    A       192.168.244.144
www     CNAME   webserv
webserv  A      8.8.8.8
webserv  A      114.114.114.114
log      A       7.7.7.7
yunwei.magedu.com. A 6.6.6.6
@      MX     10  mailserv1
@      MX     20  mailserv2
mailserv1  A    11.11.11.11
mailserv2  A    12.12.12.12
@  A   8.8.8.8
*  A   8.8.8.8       
```


## 实验三：建立反向DNS解析服务器 
### 1.修改配置文件/etc/named.rfc1912.zones ,在里面添加如下字段 
```

zone "244.168.192.in-addr.arpa" {
        type master;
        file "192.168.244.zone";
};
```
***注意***：因为要建立DNS反向解析服务器，同时要对一个网段解析，所以域的名字要写成"244.168.192.in-addr.arpa" 。  
***注意***：file "192.168.244.zone"规定了域的文件，所以下一步要建立这个数据库文件。  
### 2.在/var/named/ 下建立数据库文件 /var/named/192.168.244.zone
格式和内容如下
```bash
[root@Centos7 /var/named 12:50:58]#vim 192.168.244.zone
$TTL 86400
@ IN SOA dnsserver admin.magedu.com. (20181125 1D 3H 1W 5H )                                                   

    NS  dnsserver
dnsserver  A 192.168.244.144
144      PTR  dnsserver.magedu.com.
100      PTR  www.magedu.com.
200      PTR  blog.magedu.com.
```
至此，DNS反向解析服务器搭建完成。客户端效果如下：
```bash
[root@centos6 network-scripts]# dig 192.168.244.100

; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.68.rc1.el6 <<>> 192.168.244.100
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NXDOMAIN, id: 28851
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0

;; QUESTION SECTION:
;192.168.244.100.               IN      A

;; AUTHORITY SECTION:
.                       10800   IN      SOA     a.root-servers.net. nstld.verisign-grs.com. 2018112401 1800 900 604800 86400

;; Query time: 758 msec
;; SERVER: 192.168.244.144#53(192.168.244.144)
;; WHEN: Sun Nov 25 13:00:41 2018
;; MSG SIZE  rcvd: 108

[root@centos6 network-scripts]# 
```
